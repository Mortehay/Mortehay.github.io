<?php
//ini_set('display_errors', 1);
include('classFunctionStorage.php');
  
if ($_POST['cable_channel_cable_data_city_eng']) {
  $selectedCity= $_POST['cable_channel_cable_data_city_eng'];
} else {
  $selectedCity = $_REQUEST['cable_channel_cable_data_city_eng'];
}  
  //$linkArchive = "'".'<a href='.'"'.'http://'.$_SERVER['SERVER_ADDR'].'/qgis-ck/tmp/archive/'.$selectedCity.'/cc/'."'".'||tmp_x.table_id||'."'".'" target="_blank">посилання на архів</a>'."'";
  $linkArchive = "'".'http://'.$_SERVER['SERVER_ADDR'].'/qgis-ck/tmp/archive/'.$selectedCity.'/cc/'."'"."||tmp_x.table_id";
  $promeLink = "/tmp/";
  $secondaryLink = "/var/www/QGIS-Web-Client-master/site/csv/archive/";
  $fileExtention ="_cable_channels.csv";
  $files = fileExistenceCheck($promeLink, $secondaryLink, $selectedCity, $fileExtention)['files'];
  $linkStorage = fileExistenceCheck($promeLink, $secondaryLink, $selectedCity, $fileExtention)['linkStorage'];
if ($files) {
  foreach($files as $file) {
    $str_file = (string)$file;
    if ($str_file !== '.' && $str_file !== '..') {
      //print_r($str_file);
      if ($str_file == $selectedCity.$fileExtention) {
        $newDBrequest = new dbConnSetClass;

        $query = "CREATE TEMP TABLE tmp_x(id serial, table_id varchar(100), tu_number varchar(300), tu_date varchar(100), rental_contract_new_num varchar(100), rental_contract_new_date varchar(100), rental_contract_new_add_num varchar(100), rental_contract_new_add_date varchar(100), acceptance_act_num varchar(100), acceptance_act_date varchar(100), cartogram_num varchar(100), cartogram_date varchar(100), cable_mount_date varchar(100), rental_contract_old_num varchar(100), rental_contract_old_date varchar(100), rental_contract_old_add_num varchar(100), rental_contract_old_add_date varchar(100),approval_cartogram_num varchar(100), approval_cartogram_date varchar(100), cable_Ukrtelefon_id varchar(100), cable_type varchar(100), cable_short_type_description varchar(100), cable_description varchar(100), cable_description_fact varchar(100), cable_diameter varchar(100), progect_number varchar(100),executive_doc_state varchar(100), notes1 varchar(100), contract_start_address varchar(100), contract_start_pit varchar(100), contract_end_address varchar(100), contract_end_pit varchar(100), contract_chanel_length varchar(100),   cable_length_house varchar(100), other_contract_channel_length varchar(100), total_cable_length varchar(100), notes2 varchar(100), rezerve1 varchar(100),  rezerve2 varchar(400),  rezerve3 varchar(100)); select copy_for_testuser('tmp_x ( table_id,  tu_number , tu_date , rental_contract_new_num , rental_contract_new_date , rental_contract_new_add_num , rental_contract_new_add_date , acceptance_act_num , acceptance_act_date , cartogram_num , cartogram_date , cable_mount_date , rental_contract_old_num , rental_contract_old_date , rental_contract_old_add_num , rental_contract_old_add_date , approval_cartogram_num , approval_cartogram_date , cable_Ukrtelefon_id , cable_type , cable_short_type_description , cable_description , cable_description_fact , cable_diameter ,  progect_number , executive_doc_state , notes1 , contract_start_address , contract_start_pit ,   contract_end_address , contract_end_pit ,  contract_chanel_length , cable_length_house , other_contract_channel_length , total_cable_length ,  notes2 , rezerve1 , rezerve2 , rezerve3 )', ".$linkStorage.", ';', 'windows-1251'); UPDATE ".$selectedCity.".".$selectedCity."_cable_channels SET summ_tu = case when tmp_x.tu_number is not null or tmp_x.tu_date is not null then tmp_x.tu_number||'/'||tmp_x.tu_date else null end, summ_contract_sum = case when tmp_x.rental_contract_new_num is not null or tmp_x.rental_contract_new_date is not null then tmp_x.rental_contract_new_num||'/'||tmp_x.rental_contract_new_date  else null end, summ_sub_contract = case when tmp_x.rental_contract_new_add_num is not null or tmp_x.rental_contract_new_add_date is not null then tmp_x.rental_contract_new_add_num||'/'||tmp_x.rental_contract_new_add_date  else null end, summ_acceptance_act = case when tmp_x.acceptance_act_num is not null or tmp_x.acceptance_act_date is not null then tmp_x.acceptance_act_num||'/'||tmp_x.acceptance_act_date   else null end,         summ_approval_cartogram =  case when tmp_x.cartogram_num is not null or tmp_x.cartogram_date is not null then  tmp_x.cartogram_num||'/'||tmp_x.cartogram_date  else null end, summ_route_description =  case when tmp_x.contract_start_address is not null or tmp_x.contract_start_pit is not null or tmp_x.contract_end_address is not null or tmp_x.contract_end_pit is not null then tmp_x.contract_start_address||'_ТК'||tmp_x.contract_start_pit||'--до--'||tmp_x.contract_end_address||'_ТК'||tmp_x.contract_end_pit   else null end, summ_cable_type =  case when tmp_x.cable_description is not null or tmp_x.contract_chanel_length is not null then  tmp_x.cable_description||'L='||tmp_x.contract_chanel_length   else null end, summ_archive_link =".$linkArchive.", table_id = tmp_x.table_id, tu_number = tmp_x.tu_number, tu_date = tmp_x.tu_date, rental_contract_new_num = tmp_x.rental_contract_new_num, rental_contract_new_date = tmp_x.rental_contract_new_date, rental_contract_new_add_num = tmp_x.rental_contract_new_add_num, rental_contract_new_add_date = tmp_x.rental_contract_new_add_date, acceptance_act_num = tmp_x.acceptance_act_num, acceptance_act_date = tmp_x.acceptance_act_date, cartogram_num = tmp_x.cartogram_num, cartogram_date = tmp_x.cartogram_date, cable_mount_date = tmp_x.cable_mount_date, rental_contract_old_num = tmp_x.rental_contract_old_num, rental_contract_old_date = tmp_x.rental_contract_old_date, rental_contract_old_add_num = tmp_x.rental_contract_old_add_num, rental_contract_old_add_date = tmp_x.rental_contract_old_add_date, approval_cartogram_num = tmp_x.approval_cartogram_num,  approval_cartogram_date = tmp_x.approval_cartogram_date, cable_Ukrtelefon_id = tmp_x.cable_Ukrtelefon_id, cable_type = tmp_x.cable_type,  cable_short_type_description = tmp_x.cable_short_type_description, cable_description = tmp_x.cable_description, cable_description_fact = tmp_x.cable_description_fact,  cable_diameter = tmp_x.cable_diameter, progect_number = tmp_x.progect_number,  executive_doc_state = tmp_x.executive_doc_state, notes1 = tmp_x.notes1, contract_start_address = tmp_x.contract_start_address, contract_start_pit = tmp_x.contract_start_pit,contract_end_address = tmp_x.contract_end_address, contract_end_pit = tmp_x.contract_end_pit, contract_chanel_length = tmp_x.contract_chanel_length, cable_length_house = tmp_x.cable_length_house, other_contract_channel_length = tmp_x.other_contract_channel_length, total_cable_length = tmp_x.total_cable_length, notes2 = tmp_x.notes2, rezerve1 = tmp_x.rezerve1, rezerve2 = tmp_x.rezerve2, rezerve3 = tmp_x.rezerve3 FROM  tmp_x WHERE " . $selectedCity.".".$selectedCity."_cable_channels.table_id = tmp_x.table_id;DROP TABLE tmp_x;";
        $queryArrayKeys = false;
        echo $query;
        $retuenedArray = $newDBrequest -> dbConnect($query, $queryArrayKeys, true);
      }
    } 
  }
}
?>

